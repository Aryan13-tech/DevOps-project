<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CloudLab Manager Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

    body { font-family:'Inter',sans-serif; background:#f8f9fb; min-height:100vh; }
    .card { background:#fff; border-radius:.75rem; box-shadow:0 4px 6px rgba(0,0,0,.06); border:1px solid #e5e7eb; padding:1.5rem; }

    .action-button { transition: all .18s; padding:.5rem 1rem; border-radius:.5rem; font-weight:500; line-height:1; }
    .btn-primary { background:#2b7cff; color:#fff; }
    .btn-primary:hover { background:#1e62cc; }
    .btn-secondary { background:#f3f4f6; color:#4b5563; }
    .btn-secondary:hover { background:#e5e7eb; }
    .btn-link { background:#2563eb; color:white; padding:.25rem .6rem; border-radius:.5rem; font-size:.75rem; }
    .btn-link:hover { background:#1d4ed8; }

    #log-content { white-space:pre; font-family:monospace; height:300px; overflow-y:scroll; background:#1f2937; color:#f9fafb; padding:1rem; border-radius:.5rem; }

    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center; z-index:60;
    }
  </style>
</head>

<body class="antialiased">

  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <h1 class="text-2xl font-bold text-gray-900">CloudLab Manager</h1>
        <span class="text-sm font-medium text-gray-500 hidden sm:inline-block">/ Dashboard</span>
      </div>
      <div class="flex items-center space-x-3">
        <button id="open-login" class="action-button btn-secondary text-sm">Login / Register</button>
        <button id="logout-button" class="action-button btn-secondary text-sm hidden">Logout</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Create -->
      <section class="lg:col-span-1">
        <div class="card h-full">
          <h2 class="text-xl font-semibold text-gray-900 mb-6 border-b pb-3">
            Create Docker Environment
          </h2>

          <form id="create-container-form" class="space-y-5">

            <!-- Docker Image -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Docker Image</label>
              <select id="docker-image" required class="w-full border border-gray-300 rounded-lg p-2.5">
                <option value="ubuntu:latest">ubuntu:latest (Default)</option>
                <option value="node:18-alpine">node:18-alpine</option>
                <option value="python:3.10-slim">python:3.10-slim</option>
                <option value="nginx:latest">nginx:latest</option>
                <option value="redis:latest">redis:latest</option>
              </select>
            </div>

            <!-- CPU + RAM -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">CPU Limit</label>
                <select id="cpu-limit" required class="w-full border border-gray-300 rounded-lg p-2.5">
                  <option value="1">1 Core</option>
                  <option value="2">2 Cores</option>
                  <option value="4">4 Cores</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">RAM Limit</label>
                <select id="ram-limit" required class="w-full border border-gray-300 rounded-lg p-2.5">
                  <option value="512m">512 MB</option>
                  <option value="1g">1 GB</option>
                  <option value="2g">2 GB</option>
                  <option value="4g">4 GB</option>
                </select>
              </div>
            </div>

            <!-- Port -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Port Number <span class="text-red-500">*</span>
              </label>
              <input
                id="port-number"
                type="number"
                class="w-full border border-gray-300 rounded-lg p-2.5"
                placeholder="Example: 8080"
                required
              />
              <p class="text-xs text-gray-500 mt-1">
                Must be between <strong>1</strong> and <strong>65535</strong>.  
                Example for a web app: <code>8080</code>, <code>3000</code>, <code>5000</code>, etc.
              </p>
            </div>

            <!-- Commands -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Initial Commands</label>
              <textarea id="commands" rows="4"
                placeholder="e.g., /bin/bash -c 'echo Hello from Ubuntu'"
                class="w-full border border-gray-300 rounded-lg p-2.5"></textarea>
            </div>

            <button type="submit" id="create-button"
              class="action-button btn-primary w-full text-base">
              Create Environment
            </button>

          </form>

          <div id="message-box"
            class="mt-4 p-3 hidden rounded-lg text-sm"></div>

        </div>
      </section>

      <!-- Running Containers -->
      <section class="lg:col-span-2">
        <div class="card">
          <h2 class="text-xl font-semibold text-gray-900 mb-6 border-b pb-3">
            Running Containers
          </h2>

          <div id="loading-indicator" class="text-center py-8 text-gray-500 hidden">
            Loading containers...
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-600">ID</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-600">Image</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-600">Port / URL</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-600">Status</th>
                  <th class="px-3 py-3 text-right text-xs font-medium text-gray-600">Actions</th>
                </tr>
              </thead>
              <tbody id="containers-list" class="bg-white divide-y divide-gray-200">
                <tr id="empty-state">
                  <td colspan="5" class="px-3 py-4 text-gray-500 text-center">
                    No running containers found. Create one to begin!
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </section>

    </div>
  </main>

  <!-- Logs Modal -->
  <div id="logs-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-6">
      <div class="flex justify-between items-center border-b pb-3 mb-4">
        <h3 class="text-xl font-semibold text-gray-900">
          Logs: <span id="modal-container-name" class="font-mono text-[#2b7cff]"></span>
        </h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>

      <pre id="log-content" class="w-full text-xs"></pre>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="modal-backdrop hidden">
    <div class="bg-white p-6 rounded-lg w-full max-w-md">
      <h3 id="auth-title" class="text-lg font-semibold mb-3">Login</h3>

      <div id="auth-msg" class="text-sm text-red-600 mb-2 hidden"></div>

      <input id="auth-username" class="w-full border p-2 rounded mb-2" placeholder="username" />
      <input id="auth-password" type="password" class="w-full border p-2 rounded mb-4" placeholder="password" />

      <div class="flex items-center space-x-2">
        <button id="auth-submit" class="action-button btn-primary flex-grow">Login</button>
        <button id="auth-toggle" class="action-button btn-secondary">Switch to Register</button>
      </div>

      <div class="text-xs text-gray-500 mt-3">
        Tip: register first, then login to create environments.
      </div>
    </div>
  </div>
<script>
const API_BASE_URL = ""; 
const REFRESH_INTERVAL = 4000;

// DOM elements
const containerList = document.getElementById("containers-list");
const form = document.getElementById("create-container-form");
const messageBox = document.getElementById("message-box");
const loadingIndicator = document.getElementById("loading-indicator");

const logsModal = document.getElementById("logs-modal");
const modalContainerName = document.getElementById("modal-container-name");
const logContent = document.getElementById("log-content");

const authModal = document.getElementById("auth-modal");
const authTitle = document.getElementById("auth-title");
const authMsg = document.getElementById("auth-msg");
const authUsername = document.getElementById("auth-username");
const authPassword = document.getElementById("auth-password");
const authSubmit = document.getElementById("auth-submit");
const authToggle = document.getElementById("auth-toggle");
const openLogin = document.getElementById("open-login");
const logoutButton = document.getElementById("logout-button");

let authMode = "login";

// ---- TOKEN HELPERS ----
function setAuthToken(token) {
  if (token) {
    localStorage.setItem("CLOUDLAB_TOKEN", token);
    logoutButton.classList.remove("hidden");
    openLogin.classList.add("hidden");
  } else {
    localStorage.removeItem("CLOUDLAB_TOKEN");
    logoutButton.classList.add("hidden");
    openLogin.classList.remove("hidden");
  }
}

function getAuthToken() {
  return localStorage.getItem("CLOUDLAB_TOKEN") || null;
}

async function fetchWithAuth(url, options = {}) {
  const token = getAuthToken();
  options.headers = options.headers || {};
  if (token) {
    options.headers["Authorization"] = "Bearer " + token;
  }
  const resp = await fetch(url, options);
  if (resp.status === 401) throw new Error("Unauthorized - Please login");
  return resp;
}

// ---- MESSAGE BOX ----
function showMessage(msg, type = "success") {
  messageBox.textContent = msg;
  messageBox.className =
    "mt-4 p-3 rounded-lg text-sm block " +
    (type === "error"
      ? "bg-red-100 text-red-800"
      : "bg-green-100 text-green-800");

  setTimeout(() => messageBox.classList.add("hidden"), 4000);
}

// ---- PORT VALIDATION ----
function isValidPort(p) {
  const num = Number(p);
  return Number.isInteger(num) && num >= 1000 && num <= 65535;
}

// ---- LOGIN / REGISTER ----
openLogin.addEventListener("click", () => {
  authMode = "login";
  authTitle.textContent = "Login";
  authSubmit.textContent = "Login";
  authToggle.textContent = "Switch to Register";
  authUsername.value = "";
  authPassword.value = "";
  authModal.classList.remove("hidden");
});

authToggle.addEventListener("click", () => {
  if (authMode === "login") {
    authMode = "register";
    authTitle.textContent = "Register";
    authSubmit.textContent = "Register";
    authToggle.textContent = "Switch to Login";
  } else {
    authMode = "login";
    authTitle.textContent = "Login";
    authSubmit.textContent = "Login";
    authToggle.textContent = "Switch to Register";
  }
});

authSubmit.addEventListener("click", async () => {
  const u = authUsername.value.trim();
  const p = authPassword.value;

  if (!u || !p) {
    authMsg.textContent = "Enter username and password.";
    authMsg.classList.remove("hidden");
    return;
  }

  authMsg.classList.add("hidden");

  try {
    if (authMode === "login") {
      const resp = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p }),
      });

      const data = await resp.json();
      if (!resp.ok) {
        authMsg.textContent = data.error || "Login failed.";
        authMsg.classList.remove("hidden");
        return;
      }

      setAuthToken(data.token);
      authModal.classList.add("hidden");
      showMessage(`Logged in as ${data.username}`);
      fetchContainers();
    } else {
      const resp = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p }),
      });

      if (!resp.ok) {
        authMsg.textContent = "Registration failed.";
        authMsg.classList.remove("hidden");
        return;
      }

      showMessage("Registered! Now login.");
      authToggle.click();
    }
  } catch (err) {
    authMsg.textContent = "Error: " + err.message;
    authMsg.classList.remove("hidden");
  }
});

logoutButton.onclick = () => {
  setAuthToken(null);
  showMessage("Logged out.");
  containerList.innerHTML = `
    <tr id="empty-state">
      <td colspan="5" class="px-3 py-4 text-gray-500 text-center">
        Please login to view containers.
      </td>
    </tr>`;
};

// ---- CREATE CONTAINER ----
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!getAuthToken()) {
    showMessage("Please login first.", "error");
    return;
  }

  const port = document.getElementById("port-number").value;
  if (!isValidPort(port)) {
    showMessage("❌ Invalid port number (1000–65535).", "error");
    return;
  }

  const payload = {
    image: document.getElementById("docker-image").value,
    cpu_limit: document.getElementById("cpu-limit").value,
    ram_limit: document.getElementById("ram-limit").value,
    port: port,
    commands: document.getElementById("commands").value.trim() || null,
  };

  try {
    const resp = await fetchWithAuth("/api/container/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const json = await resp.json();
    if (!resp.ok) {
      showMessage(json.error || "Creation failed", "error");
      return;
    }

    showMessage(`Container running at http://localhost:${json.port}`);
    form.reset();
    fetchContainers();
  } catch (err) {
    showMessage("Create error: " + err.message, "error");
  }
});

// ---- LIST CONTAINERS ----
async function fetchContainers() {
  if (!getAuthToken()) return;
  loadingIndicator.classList.remove("hidden");
  containerList.innerHTML = "";

  try {
    const resp = await fetchWithAuth("/api/container/list");
    const data = await resp.json();

    if (!data.length) {
      containerList.innerHTML =
        `<tr><td colspan="5" class="text-center py-4 text-gray-500">No containers found</td></tr>`;
      return;
    }

    data.forEach((c) => {
      const port = c.Port || "";
      const url = port
        ? `<a href="http://localhost:${port}" target="_blank" class="btn-link">Open</a>`
        : `<span class="text-gray-400 text-sm">No port</span>`;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-3 py-3 font-mono">${c.ContainerID.slice(0, 12)}</td>
        <td class="px-3 py-3">${c.Image}</td>
        <td class="px-3 py-3">${url}</td>
        <td class="px-3 py-3">
          <span class="px-2 py-1 text-xs rounded-full ${
            c.Status === "running"
              ? "bg-green-100 text-green-700"
              : "bg-yellow-100 text-yellow-700"
          }">${c.Status}</span>
        </td>
        <td class="px-3 py-3 text-right space-x-2">
          <button class="action-button btn-secondary" onclick="viewLogs('${c.name}')">Logs</button>
          <button class="action-button bg-yellow-500 hover:bg-yellow-600 text-white" onclick="stopContainer('${c.name}')">Stop</button>
          <button class="action-button bg-green-500 hover:bg-green-600 text-white" onclick="startContainer('${c.name}')">Start</button>
          <button class="action-button bg-red-500 hover:bg-red-600 text-white" onclick="deleteContainer('${c.name}')">Delete</button>
        </td>
      `;
      containerList.appendChild(row);
    });
  } catch (err) {
    showMessage("Fetch error: " + err.message, "error");
  } finally {
    loadingIndicator.classList.add("hidden");
  }
}

// ---- ACTIONS ----
window.stopContainer = async (name) => {
  await fetchWithAuth(`/api/container/stop/${name}`, { method: "POST" });
  fetchContainers();
};

window.startContainer = async (name) => {
  await fetchWithAuth(`/api/container/start/${name}`, { method: "POST" });
  fetchContainers();
};

window.deleteContainer = async (name) => {
  if (!confirm("Delete container?")) return;
  await fetchWithAuth(`/api/container/delete/${name}`, { method: "DELETE" });
  fetchContainers();
};

window.viewLogs = async (name) => {
  logsModal.classList.remove("hidden");
  modalContainerName.textContent = name;
  logContent.textContent = "Loading...";

  const resp = await fetchWithAuth(`/api/container/logs/${name}`);
  logContent.textContent = await resp.text();
};

document.getElementById("close-modal").onclick = () =>
  logsModal.classList.add("hidden");

// ---- INIT ----
(function init() {
  if (getAuthToken()) {
    logoutButton.classList.remove("hidden");
    openLogin.classList.add("hidden");
    fetchContainers();
  }
  setInterval(fetchContainers, REFRESH_INTERVAL);
})();
</script>


</body>
</html>
