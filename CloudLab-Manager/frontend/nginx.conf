# =========================================================
# FINAL PRODUCTION-READY CONFIG (Works for Testing + Final)
# =========================================================

# ---- BACKEND UPSTREAM (works when using Docker Compose / ECS) ----
upstream backend_server {
    server cloudlab-backend:8000;     # Future production backend container
}

server {
    listen 80;
    server_name _;

    # ---------------- API ROUTES ----------------
    # Try container backend first → if unreachable, fallback to EC2 backend IP.
    location /api/ {

        # Primary backend → container name (future production)
        proxy_pass http://backend_server;

        # Fallback backend → your EC2 backend (testing mode)
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        proxy_pass http://18.232.188.143:8080;

        # Common proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ---------------- FRONTEND ROUTES ----------------
    location / {
        root /usr/share/nginx/html;
        try_files $uri /index.html;
    }
}
