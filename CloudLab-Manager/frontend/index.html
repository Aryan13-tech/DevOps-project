<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CloudLab Manager Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family:'Inter',sans-serif; background:#f8f9fb; min-height:100vh; }
    .card { background:#fff; border-radius:.75rem; box-shadow:0 4px 6px rgba(0,0,0,.06); border:1px solid #e5e7eb; padding:1.5rem; }
    .action-button { transition: all .18s; padding:.5rem 1rem; border-radius:.5rem; font-weight:500; line-height:1; }
    .btn-primary { background:#2b7cff; color:#fff; }
    .btn-primary:hover { background:#1e62cc; }
    .btn-secondary { background:#f3f4f6; color:#4b5563; }
    .btn-secondary:hover { background:#e5e7eb; }
    .btn-link { background:#2563eb; color:white; padding:.25rem .6rem; border-radius:.5rem; font-size:.75rem; }
    .btn-link:hover { background:#1d4ed8; }
    #log-content { white-space:pre; font-family:monospace; height:300px; overflow-y:scroll; background:#1f2937; color:#f9fafb; padding:1rem; border-radius:.5rem; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:60; }
  </style>
</head>

<body class="antialiased">

  <!-- HEADER -->
  <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-900">CloudLab Manager</h1>

      <div class="flex items-center space-x-4">
        <span id="user-display" class="text-gray-700 font-medium hidden"></span>
        <button id="open-login" class="action-button btn-secondary text-sm">Login / Register</button>
        <button id="logout-button" class="action-button btn-secondary text-sm hidden">Logout</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- CREATE DOCKER ENV -->
      <section>
        <div class="card">
          <h2 class="text-xl font-semibold text-gray-900 mb-6 border-b pb-3">Create Docker Environment</h2>

          <form id="create-container-form" class="space-y-5">

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Docker Image</label>
              <select id="docker-image" class="w-full border p-2.5 rounded-lg">
                <option value="ubuntu:latest">ubuntu:latest</option>
                <option value="node:18-alpine">node:18-alpine</option>
                <option value="python:3.10-slim">python:3.10-slim</option>
              </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">CPU Limit</label>
                <select id="cpu-limit" class="w-full border p-2.5 rounded-lg">
                  <option value="1">1 Core</option>
                  <option value="2">2 Cores</option>
                  <option value="4">4 Cores</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">RAM Limit</label>
                <select id="ram-limit" class="w-full border p-2.5 rounded-lg">
                  <option value="512m">512 MB</option>
                  <option value="1g">1 GB</option>
                  <option value="2g">2 GB</option>
                  <option value="4g">4 GB</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm mb-1">Port Number *</label>
              <input id="port-number" type="number" placeholder="8080"
                class="w-full border p-2.5 rounded-lg" required />
            </div>

            <div>
              <label class="block text-sm mb-1">Initial Commands</label>
              <textarea id="commands" rows="4" placeholder="echo Hello"
                class="w-full border p-2.5 rounded-lg"></textarea>
            </div>

            <button id="create-button" type="submit"
              class="action-button btn-primary w-full">Create Environment</button>

          </form>

          <div id="message-box" class="hidden mt-4 p-3 rounded text-sm"></div>
        </div>
      </section>

      <!-- RUNNING CONTAINERS -->
      <section class="lg:col-span-2">
        <div class="card">
          <h2 class="text-xl font-semibold mb-6 border-b pb-3">Running Containers</h2>

          <div id="loading-indicator" class="text-center py-8 hidden text-gray-500">Loading...</div>

          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-3 text-left text-xs text-gray-600">ID</th>
                <th class="px-3 py-3 text-left text-xs text-gray-600">Image</th>
                <th class="px-3 py-3 text-left text-xs text-gray-600">Port / URL</th>
                <th class="px-3 py-3 text-left text-xs text-gray-600">Status</th>
                <th class="px-3 py-3 text-right text-xs text-gray-600">Actions</th>
              </tr>
            </thead>
            <tbody id="containers-list" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <!-- LOGS MODAL -->
  <div id="logs-modal" class="modal-backdrop hidden">
    <div class="bg-white p-6 rounded-xl w-full max-w-2xl">
      <div class="flex justify-between border-b pb-3 mb-4">
        <h3 class="text-xl font-semibold">Logs: <span id="modal-container-name" class="text-blue-600"></span></h3>
        <button id="close-modal" class="text-gray-500">âœ•</button>
      </div>
      <pre id="log-content" class="text-xs bg-gray-900 text-white p-3 rounded"></pre>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="auth-modal" class="modal-backdrop hidden">
    <div class="bg-white p-6 rounded-lg w-full max-w-md">
      <h3 id="auth-title" class="text-xl font-semibold mb-3">Login</h3>

      <div id="auth-msg" class="hidden text-sm text-red-600 mb-2"></div>

      <input id="auth-username" class="w-full p-2 border rounded mb-2" placeholder="Username" />
      <input id="auth-password" type="password" class="w-full p-2 border rounded mb-4" placeholder="Password" />

      <div class="flex space-x-2">
        <button id="auth-submit" class="btn-primary action-button flex-grow">Login</button>
        <button id="auth-toggle" class="btn-secondary action-button">Switch to Register</button>
      </div>
    </div>
  </div>

<script>
/* ---------------- Settings ---------------- */
const API_BASE_URL = "";
const REFRESH_INTERVAL = 3000;

/* ---------------- DOM ---------------- */
const containerList = document.getElementById("containers-list");
const form = document.getElementById("create-container-form");
const messageBox = document.getElementById("message-box");
const loadingIndicator = document.getElementById("loading-indicator");

const openLogin = document.getElementById("open-login");
const logoutButton = document.getElementById("logout-button");
const userDisplay = document.getElementById("user-display");

const authModal = document.getElementById("auth-modal");
const authTitle = document.getElementById("auth-title");
const authMsg = document.getElementById("auth-msg");
const authSubmit = document.getElementById("auth-submit");
const authToggle = document.getElementById("auth-toggle");
const usernameInput = document.getElementById("auth-username");
const passwordInput = document.getElementById("auth-password");

let authMode = "login";

/* ---------------- Token Helpers ---------------- */
function setAuthToken(token, username = null) {
  if (token) {
    localStorage.setItem("CLOUDLAB_TOKEN", token);
    if (username) localStorage.setItem("CLOUDLAB_USERNAME", username);

    userDisplay.textContent = "Hello, " + localStorage.getItem("CLOUDLAB_USERNAME");
    userDisplay.classList.remove("hidden");

    openLogin.classList.add("hidden");
    logoutButton.classList.remove("hidden");
  } else {
    localStorage.removeItem("CLOUDLAB_TOKEN");
    localStorage.removeItem("CLOUDLAB_USERNAME");

    userDisplay.classList.add("hidden");

    openLogin.classList.remove("hidden");
    logoutButton.classList.add("hidden");
  }
}

function getAuthToken() {
  return localStorage.getItem("CLOUDLAB_TOKEN") || null;
}

async function fetchWithAuth(url, options = {}) {
  const token = getAuthToken();
  options.headers = options.headers || {};
  if (token) options.headers["Authorization"] = "Bearer " + token;

  const resp = await fetch(url, options);
  if (resp.status === 401) throw new Error("Unauthorized");
  return resp;
}

/* ---------------- Utility ---------------- */
function showMessage(msg, type = "success") {
  messageBox.classList.remove("hidden");
  messageBox.textContent = msg;

  messageBox.className =
    "mt-4 p-3 rounded-lg text-sm " +
    (type === "error" ? "bg-red-100 text-red-800" : "bg-green-100 text-green-800");

  setTimeout(() => messageBox.classList.add("hidden"), 4000);
}

function isValidPort(p) {
  const num = Number(p);
  return Number.isInteger(num) && num >= 1 && num <= 65535;
}

/* ---------------- Login / Register ---------------- */
openLogin.addEventListener("click", () => {
  authMode = "login";
  authTitle.textContent = "Login";
  authSubmit.textContent = "Login";
  authToggle.textContent = "Switch to Register";
  usernameInput.value = "";
  passwordInput.value = "";
  authModal.classList.remove("hidden");
});

authToggle.addEventListener("click", () => {
  if (authMode === "login") {
    authMode = "register";
    authTitle.textContent = "Register";
    authSubmit.textContent = "Register";
    authToggle.textContent = "Switch to Login";
  } else {
    authMode = "login";
    authTitle.textContent = "Login";
    authSubmit.textContent = "Login";
    authToggle.textContent = "Switch to Register";
  }
});

authSubmit.addEventListener("click", async () => {
  const username = usernameInput.value.trim();
  const password = passwordInput.value;

  if (!username || !password) {
    authMsg.textContent = "Both fields required";
    authMsg.classList.remove("hidden");
    return;
  }

  authMsg.classList.add("hidden");

  try {
    if (authMode === "login") {
      const resp = await fetch("/api/auth/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username, password})
      });

      const data = await resp.json();
      if (!resp.ok) {
        authMsg.textContent = data.error;
        authMsg.classList.remove("hidden");
        return;
      }

      setAuthToken(data.token, data.username);
      authModal.classList.add("hidden");
      showMessage("Logged in successfully!");
      fetchContainers();

    } else {
      const resp = await fetch("/api/auth/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username, password})
      });

      if (!resp.ok) {
        authMsg.textContent = "Registration failed";
        authMsg.classList.remove("hidden");
        return;
      }

      showMessage("Account created! Please log in.");
      authToggle.click();
    }

  } catch (err) {
    authMsg.textContent = "Error: " + err.message;
    authMsg.classList.remove("hidden");
  }
});

logoutButton.addEventListener("click", () => {
  setAuthToken(null);
  containerList.innerHTML =
    `<tr><td colspan="5" class="text-center p-4 text-gray-500">Please login.</td></tr>`;
  showMessage("Logged out");
});

/* ---------------- CREATE CONTAINER ---------------- */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!getAuthToken()) {
    showMessage("Please login.", "error");
    return;
  }

  const port = document.getElementById("port-number").value;

  if (!isValidPort(port)) {
    showMessage("Invalid port number.", "error");
    return;
  }

  const payload = {
    image: document.getElementById("docker-image").value,
    cpu_limit: document.getElementById("cpu-limit").value,
    ram_limit: document.getElementById("ram-limit").value,
    commands: document.getElementById("commands").value.trim(),
    port: port
  };

  try {
    const resp = await fetchWithAuth("/api/container/create", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    const data = await resp.json();
    if (!resp.ok) {
      showMessage(data.error, "error");
      return;
    }

    showMessage("Container created on port " + data.Port);
    fetchContainers();

  } catch (err) {
    showMessage("Error: " + err.message, "error");
  }
});

/* ---------------- LIST CONTAINERS ---------------- */
async function fetchContainers() {
  if (!getAuthToken()) return;

  containerList.innerHTML = "";
  loadingIndicator.classList.remove("hidden");

  try {
    const resp = await fetchWithAuth("/api/container/list");
    const data = await resp.json();

    if (!data.length) {
      containerList.innerHTML =
        `<tr><td colspan="5" class="text-center p-4 text-gray-500">No containers</td></tr>`;
      return;
    }

    data.forEach(c => {
      const url = c.Port
        ? `<a target="_blank" class="btn-link" href="http://localhost:${c.Port}">Open</a>`
        : `<span class="text-gray-400 text-xs">None</span>`;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-3 py-2 font-mono">${c.ContainerID}</td>
        <td class="px-3 py-2">${c.Image}</td>
        <td class="px-3 py-2">${url}</td>
        <td class="px-3 py-2">${c.Status}</td>
        <td class="px-3 py-2 text-right">
          <button onclick="viewLogs('${c.name}')" class="btn-secondary action-button">Logs</button>
          <button onclick="stopContainer('${c.name}')" class="btn-secondary action-button">Stop</button>
          <button onclick="deleteContainer('${c.name}')" class="btn-secondary action-button">Delete</button>
        </td>`;
      containerList.appendChild(row);
    });

  } finally {
    loadingIndicator.classList.add("hidden");
  }
}

/* ---------------- ACTIONS ---------------- */
window.stopContainer = async (name) => {
  await fetchWithAuth(`/api/container/stop/${name}`, {method: "POST"});
  fetchContainers();
};
window.deleteContainer = async (name) => {
  if (!confirm("Delete?")) return;
  await fetchWithAuth(`/api/container/delete/${name}`, {method: "DELETE"});
  fetchContainers();
};
window.viewLogs = async (name) => {
  document.getElementById("logs-modal").classList.remove("hidden");
  const resp = await fetchWithAuth(`/api/container/logs/${name}`);
  document.getElementById("log-content").textContent = await resp.text();
};
document.getElementById("close-modal").onclick =
  () => document.getElementById("logs-modal").classList.add("hidden");

/* ---------------- INIT ---------------- */
(function init() {
  const savedUser = localStorage.getItem("CLOUDLAB_USERNAME");
  if (savedUser) {
    userDisplay.textContent = "Hello, " + savedUser;
    userDisplay.classList.remove("hidden");
    openLogin.classList.add("hidden");
    logoutButton.classList.remove("hidden");
    fetchContainers();
  }
  setInterval(fetchContainers, REFRESH_INTERVAL);
})();
</script>

</body>
</html>
